<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ツイステ キャラ管理</title>

<style>

th:first-child,
td:first-child {
  width: 1%;
  white-space: nowrap;
  text-align: left;
}

.name-cell {
  display: inline-flex;   /* ← オートサイズに戻す */
  align-items: center;
  gap: 8px;
  white-space: nowrap;
}

.detail-arrow {
  margin-left: 6px;       /* 名前のすぐ右 */
  color: #aaa;
}

tbody tr:hover .detail-arrow {
  color: #333;
}

tbody tr {
  cursor: pointer;
  transition: background 0.15s ease;
}

/* hover */
tbody tr:hover {
  background: #f1ece2;
}

/* 押している間 */
tbody tr:active {
  background: #d8c8a0;
}

/* 押したあと一瞬残る */
tbody tr.clicked {
  background: #d8c8a0;
}


body {
  margin: 0;
  background: #e3dfd4;
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
}

header, footer {
  background: #1e1e1e;
  color: #fff;
  text-align: center;
  padding: 14px;
}

main { padding: 12px; }

button {
  padding: 6px 12px;
  margin: 4px;
  font-size: 13px;
  cursor: pointer;
}

button.active {
  background: #333;
  color: #fff;
}

input {
  width: 100%;
  padding: 8px;
  margin: 10px 0;
}

/* ===== 一覧 ===== */
.table-scroll {
  background: #fff;
  border-radius: 10px;
  border: 1px solid #ccc;
  overflow-x: auto;
}

table {
  width: 100%;
  min-width: 720px;
  border-collapse: collapse;
}

th, td {
  border: 1px solid #ddd;
  padding: 8px;
  font-size: 13px;
  text-align: center;
}

/* ===== 名前列：左寄せ＆オートサイズ ===== */



.name-cell img {
  width: 42px;
  height: 42px;
  border-radius: 6px;
}

/* ===== Magic属性アイコンだけ小さく（安全） ===== */
td:nth-child(4) img,
td:nth-child(5) img,
td:nth-child(6) img {
  width: 25px;
  height: 25px;
}

/* ===== Magic列もオートサイズ ===== */
th:nth-child(4),
th:nth-child(5),
th:nth-child(6),
td:nth-child(4),
td:nth-child(5),
td:nth-child(6) {
  width: 1%;
  white-space: nowrap;
}

/* ===== アイコンのみ ===== */
#icon-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 10px;
}

.icon-item {
  background: #fff;
  border-radius: 10px;
  padding: 10px;
  text-align: center;
  border: 1px solid #ccc;
}

.icon-item img {
  width: 64px;
  height: 64px;
}

/* ===== モーダル ===== */
#overlay {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.6);
  z-index: 999;
}

#detailImage {
  width: 100%;
  max-height: 70vh;

  aspect-ratio: 16 / 9;
  object-fit: contain;

  background: #000;   /* 黒帯になっても違和感なし */
  border-radius: 6px;
}

#detail-modal {
  background: #f6f1e7;
  border: 2px solid #c9b37e;
  max-width: 560px;
  max-height: 90vh;
  overflow-y: auto;
  margin: 30px auto;
}

.detail-header {
  background: #1e1e1e;
  color: #fff;
  padding: 10px 14px;
  display: flex;
  justify-content: space-between;
  position: sticky;
  top: 0;
}

.close-btn {
  font-size: 22px;
  cursor: pointer;
}

.detail-body {
  display: grid;
  grid-template-columns: 1.3fr 1fr;
  gap: 14px;
  padding: 14px;
}

.detail-body img {
  width: 100%;
  border-radius: 6px;
  border: 1px solid #bbb;
}

.groovy-btn {
  width: 100%;
  margin-top: 6px;
}

/* ===== モーダル内 MAGIC 属性アイコンサイズ ===== */
#detail-modal .section img {
  width: 25px;
  height: 25px;
}

/* ===== セクション ===== */
.section {
  margin: 14px;
  border-top: 2px solid #c9b37e;
  padding-top: 10px;
}

.section h3 {
  margin: 0 0 8px;
  font-size: 13px;
  background: #d8c8a0;
  color: #4a3b1a;
  display: inline-block;
  padding: 4px 8px;
}

.desc {
  font-size: 12px;
  margin-bottom: 8px;
}

.buddy-row { margin-bottom: 8px; }

@media (max-width: 600px) {
  .detail-body { grid-template-columns: 1fr; }
}
</style>
</head>

<body>

<header><h1>ツイステ キャラ管理</h1></header>

<main>
<button id="toggleBtn">ステータス表示：ON</button>
<input id="searchInput" placeholder="キャラ名で検索">

<div>
  <button id="sortHpBtn">HP ↓</button>
  <button id="sortAtkBtn">ATK ↓</button>
  <button id="resetBtn" class="active">デフォルト</button>
</div>

<section id="character-list-section">
  <div class="table-scroll">
    <table>
      <thead>
        <tr>
          <th>名前</th><th>HP</th><th>ATK</th>
          <th>Magic1</th><th>Magic2</th><th>Magic3</th>
        </tr>
      </thead>
      <tbody id="character-table-body"></tbody>
    </table>
  </div>
</section>

<section id="icon-only-section" style="display:none;">
  <div id="icon-grid"></div>
</section>
</main>

<footer>© 非公式ファンサイト</footer>

<!-- ===== モーダル ===== -->
<div id="overlay">
  <div id="detail-modal">
    <div class="detail-header">
      <span>最大ステータス</span>
      <span class="close-btn" id="closeModal">×</span>
    </div>

    <div class="detail-body">
      <div>
        <img id="detailImage">
        <button id="groovyBtn" class="groovy-btn">Groovy After</button>
      </div>

      <div>
        <h2 id="detailName"></h2>
        <div>HP <span id="detailHp"></span></div>
        <div>ATK <span id="detailAtk"></span></div>
      </div>
    </div>

    <div class="section">
      <h3>MAGIC</h3>
      <div id="magic1Row">
        <img id="m1Icon">
        <div class="desc" id="detailM1Desc"></div>
      </div>
      <div id="magic2Row">
        <img id="m2Icon">
        <div class="desc" id="detailM2Desc"></div>
      </div>
      <div id="magic3Row">
        <img id="m3Icon">
        <div class="desc" id="detailM3Desc"></div>
      </div>
    </div>

    <div class="section">
      <h3>BUDDY</h3>
      <div class="buddy-row">
        <strong id="buddy1"></strong>
        <div id="buddy1Bonus"></div>
      </div>
      <div class="buddy-row">
        <strong id="buddy2"></strong>
        <div id="buddy2Bonus"></div>
      </div>
      <div class="buddy-row">
        <strong id="buddy3"></strong>
        <div id="buddy3Bonus"></div>
      </div>
    </div>
  </div>
</div>


<script>
let characters = [];
let currentList = [];
let statusOn = true;
let hpAsc = false;
let atkAsc = false;
let groovy = false;

const body = document.getElementById('character-table-body');
const iconGrid = document.getElementById('icon-grid');
const listSection = document.getElementById('character-list-section');
const iconSection = document.getElementById('icon-only-section');

const toggleBtn = document.getElementById('toggleBtn');
const sortHpBtn = document.getElementById('sortHpBtn');
const sortAtkBtn = document.getElementById('sortAtkBtn');
const resetBtn = document.getElementById('resetBtn');
const searchInput = document.getElementById('searchInput');

const overlay = document.getElementById('overlay');
const closeModal = document.getElementById('closeModal');
const detailName = document.getElementById('detailName');
const detailHp = document.getElementById('detailHp');
const detailAtk = document.getElementById('detailAtk');
const detailImage = document.getElementById('detailImage');
const groovyBtn = document.getElementById('groovyBtn');

const m1Icon = document.getElementById('m1Icon');
const m2Icon = document.getElementById('m2Icon');
const m3Icon = document.getElementById('m3Icon');
const detailM1Desc = document.getElementById('detailM1Desc');
const detailM2Desc = document.getElementById('detailM2Desc');
const detailM3Desc = document.getElementById('detailM3Desc');
const magic1Row = document.getElementById('magic1Row');
const magic2Row = document.getElementById('magic2Row');
const magic3Row = document.getElementById('magic3Row');

const buddy1 = document.getElementById('buddy1');
const buddy2 = document.getElementById('buddy2');
const buddy3 = document.getElementById('buddy3');
const buddy1Bonus = document.getElementById('buddy1Bonus');
const buddy2Bonus = document.getElementById('buddy2Bonus');
const buddy3Bonus = document.getElementById('buddy3Bonus');

function getAttrIcon(attr) {
  if (!attr) return '';
  if (attr === '火') return 'image/Element/Fire.png';
  if (attr === '水') return 'image/Element/Water.png';
  if (attr === '木') return 'image/Element/Leaf.png';
  if (attr === '無') return 'image/Element/ZERO.png';
  return '';
}

fetch('./characters.json')
  .then(res => res.json())
  .then(data => {
    characters = data;
    render(data);
  });

function createImagePaths(iconPath) {
  // /icon/ を削除
  const defaultImage = iconPath.replace('/icon/', '/');

  // 拡張子の前に _G を付ける
  const groovyImage = defaultImage.replace(/(\.[a-zA-Z]+)$/, '_G$1');

  return { defaultImage, groovyImage };
}

function render(list) {
  currentList = list;
  body.innerHTML = '';
  iconGrid.innerHTML = '';

  list.forEach(c => {
    
    const images = createImagePaths(c.icon);
    c.defaultImage = images.defaultImage;
    c.groovyImage = images.groovyImage;
    
    /* ===== ここが重要：完全先読み ===== */
    preloadImage(c.icon);
  
    
    body.innerHTML += `
      <tr onclick='openDetail(${JSON.stringify(c)}, this)'>
        <td>
  <div class="name-cell">
    <img src="${c.icon}">
    <span>${c.name}</span>
    <span class="detail-arrow">▶</span>
  </div>
</td><td>${c.hp ?? '-'}</td>
        <td>${c.atk ?? '-'}</td>
        <td>${c.mg1 ? `<img src="${getAttrIcon(c.mg1)}">` : ''}</td>
        <td>${c.mg2 ? `<img src="${getAttrIcon(c.mg2)}">` : ''}</td>
        <td>${c.mg3 ? `<img src="${getAttrIcon(c.mg3)}">` : ''}</td>
      </tr>
    `;

    iconGrid.innerHTML += `
      <div class="icon-item" onclick='openDetail(${JSON.stringify(c)})'>
        <img src="${c.icon}">
        <div>${c.name}</div>
      </div>
    `;
  });
}

/* ===== ON/OFF ===== */
toggleBtn.onclick = () => {
  statusOn = !statusOn;
  listSection.style.display = statusOn ? 'block' : 'none';
  iconSection.style.display = statusOn ? 'none' : 'block';
  toggleBtn.textContent = statusOn ? 'ステータス表示：ON' : 'ステータス表示：OFF';
};

/* ===== ソート ===== */
sortHpBtn.onclick = () => {
  hpAsc = !hpAsc;
  atkAsc = false;

  sortHpBtn.textContent = hpAsc ? 'HP ↑' : 'HP ↓';
  sortAtkBtn.textContent = 'ATK ↓';

  sortHpBtn.classList.add('active');
  sortAtkBtn.classList.remove('active');
  resetBtn.classList.remove('active');

  render([...currentList].sort((a,b)=>
    hpAsc ? (a.hp??0)-(b.hp??0) : (b.hp??0)-(a.hp??0)
  ));
};

sortAtkBtn.onclick = () => {
  atkAsc = !atkAsc;
  hpAsc = false;

  sortAtkBtn.textContent = atkAsc ? 'ATK ↑' : 'ATK ↓';
  sortHpBtn.textContent = 'HP ↓';

  sortAtkBtn.classList.add('active');
  sortHpBtn.classList.remove('active');
  resetBtn.classList.remove('active');

  render([...currentList].sort((a,b)=>
    atkAsc ? (a.atk??0)-(b.atk??0) : (b.atk??0)-(a.atk??0)
  ));
};

resetBtn.onclick = () => {
  hpAsc = false;
  atkAsc = false;

  sortHpBtn.textContent = 'HP ↓';
  sortAtkBtn.textContent = 'ATK ↓';

  sortHpBtn.classList.remove('active');
  sortAtkBtn.classList.remove('active');
  resetBtn.classList.add('active');

  render(characters);
};

/* ===== 検索 ===== */
searchInput.oninput = () => {
  render(characters.filter(c => c.name.includes(searchInput.value)));
};

/* ===== モーダル ===== */
function openDetail(c, el) {

function openDetail(c, el) {

  // ★ すべての行のハイライトを解除
  document.querySelectorAll('#character-table-body tr')
    .forEach(tr => tr.classList.remove('clicked'));

  // ★ 押した行だけハイライト
  if (el) {
    el.classList.add('clicked');
  }

  // ★ 先に読み込み開始
  preloadImage(c.defaultImage);
  preloadImage(c.groovyImage);

  detailImage.src = c.defaultImage
  
  overlay.style.display = 'block';

  detailName.textContent = c.name;
  detailHp.textContent = c.hp ?? '-';
  detailAtk.textContent = c.atk ?? '-';

  setupMagic(c.mg1, c.mg1_description, m1Icon, detailM1Desc, magic1Row);
  setupMagic(c.mg2, c.mg2_description, m2Icon, detailM2Desc, magic2Row);
  setupMagic(c.mg3, c.mg3_description, m3Icon, detailM3Desc, magic3Row);

  buddy1.textContent = c.buddy1 || '';
  buddy1Bonus.textContent = c.buddy1_bonus || '';
  buddy2.textContent = c.buddy2 || '';
  buddy2Bonus.textContent = c.buddy2_bonus || '';
  buddy3.textContent = c.buddy3 || '';
  buddy3Bonus.textContent = c.buddy3_bonus || '';

  groovy = false;


  if (c.rarity === 'R') {
    groovyBtn.style.display = 'none';
  } else {
    groovyBtn.style.display = 'block';
    groovyBtn.onclick = () => {
      groovy = !groovy;
      detailImage.src = groovy ? c.groovyImage : c.defaultImage;
    };
  }
}

function setupMagic(attr, desc, iconEl, descEl, rowEl) {
  if (!attr) {
    rowEl.style.display = 'none';
    return;
  }
  rowEl.style.display = '';
  iconEl.src = getAttrIcon(attr);
  descEl.textContent = desc || '';
}
function preloadImage(src) {
  if (!src) return;
  const img = new Image();
  img.src = src;
}


closeModal.onclick = () => overlay.style.display = 'none';
</script>

</body>
</html>